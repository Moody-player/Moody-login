<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moody ì‹œì‘í•˜ê¸°</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: linear-gradient(135deg, #1DB954 0%, #191414 100%);
            color: white; 
            padding: 20px; 
            line-height: 1.5; 
            margin: 0;
            min-height: 100vh;
        }
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            padding-bottom: 50px; 
        }
        h1 { 
            text-align: center; 
            color: #1DB954; 
            margin-bottom: 10px; 
            font-size: 32px; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .subtitle {
            text-align: center;
            color: #aaa;
            font-size: 14px;
            margin-bottom: 30px;
        }
        .section-box { 
            background: rgba(24, 24, 24, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px; 
            border-radius: 20px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.7); 
            margin-bottom: 25px; 
            border: 1px solid rgba(29, 185, 84, 0.3);
        }
        .step-number {
            display: inline-block;
            width: 32px;
            height: 32px;
            background: #1DB954;
            color: black;
            border-radius: 50%;
            text-align: center;
            line-height: 32px;
            font-weight: bold;
            margin-right: 10px;
        }
        .section-title { 
            font-size: 20px; 
            font-weight: bold; 
            color: #fff; 
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        .info-text {
            font-size: 14px;
            color: #b3b3b3;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        button.main-btn { 
            width: 100%; 
            padding: 20px; 
            background-color: #1DB954; 
            color: black; 
            border: none; 
            border-radius: 50px; 
            font-size: 20px; 
            font-weight: bold; 
            cursor: pointer; 
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(29, 185, 84, 0.4);
            transition: all 0.3s;
        }
        button.main-btn:hover { 
            background-color: #1ed760; 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(29, 185, 84, 0.6);
        }
        button.main-btn:active {
            transform: translateY(0);
        }
        
        /* ê²°ê³¼ í™”ë©´ */
        #result-area { 
            display: none;
            background: rgba(34, 34, 34, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px; 
            border-radius: 20px; 
            border: 2px solid #1DB954;
            box-shadow: 0 8px 32px rgba(29, 185, 84, 0.3);
        }
        .success-icon {
            text-align: center;
            font-size: 60px;
            margin-bottom: 20px;
            animation: bounce 0.5s;
        }
        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        textarea { 
            width: 100%; 
            height: 180px; 
            background: #000; 
            color: #1DB954; 
            border: 1px solid #1DB954; 
            padding: 15px; 
            font-family: 'Courier New', monospace; 
            font-size: 13px; 
            box-sizing: border-box; 
            margin-top: 15px;
            border-radius: 10px;
            resize: vertical;
        }
        .copy-btn {
            background: #1DB954;
            color: black;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            width: 100%;
            font-size: 16px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #1DB954;
        }
        .loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        .warning {
            background: rgba(255, 193, 7, 0.1);
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-size: 13px;
            color: #ffc107;
        }
        .feature-list {
            background: rgba(29, 185, 84, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        .feature-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            font-size: 14px;
        }
        .feature-item::before {
            content: 'âœ“';
            color: #1DB954;
            font-weight: bold;
            margin-right: 10px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ Moody ì‹œì‘í•˜ê¸°</h1>
        <p class="subtitle">ê°„í¸í•œ 1í´ë¦­ ì¸ì¦ (PKCE ë°©ì‹)</p>

        <div class="section-box">
            <div class="section-title">
                <span class="step-number">1</span>
                Spotify ê³„ì • ì—°ë™
            </div>
            <p class="info-text">
                MoodyëŠ” ì•ˆì „í•œ PKCE ë°©ì‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.<br>
                ë³µì¡í•œ ì„¤ì • ì—†ì´ ë²„íŠ¼ í•˜ë‚˜ë¡œ ëª¨ë“  ì¸ì¦ì´ ì™„ë£Œë©ë‹ˆë‹¤.
            </p>
            
            <div class="feature-list">
                <div class="feature-item">ê°œë°œì ê³„ì • ìƒì„± ë¶ˆí•„ìš”</div>
                <div class="feature-item">ì•± ë“±ë¡ ë¶ˆí•„ìš”</div>
                <div class="feature-item">Client Secret ë…¸ì¶œ ê±±ì • ì—†ìŒ</div>
                <div class="feature-item">ì™„ì „ ìë™í™”ëœ ì•ˆì „í•œ ì¸ì¦</div>
            </div>

            <button class="main-btn" onclick="startAuth()" id="loginBtn">
                ğŸµ Spotifyë¡œ ë¡œê·¸ì¸
            </button>
        </div>

        <div class="section-box" id="loading-area" style="display:none;">
            <div class="loading">ì¸ì¦ ì²˜ë¦¬ ì¤‘</div>
        </div>

        <div id="result-area">
            <div class="success-icon">âœ…</div>
            <h2 style="color:#1DB954; margin-top:0; text-align:center;">ì¸ì¦ ì™„ë£Œ!</h2>
            <p style="font-size:14px; color:#aaa; text-align:center;">
                ì•„ë˜ ì½”ë“œë¥¼ ë³µì‚¬í•˜ì—¬ Moody ì„¤ì • í™”ë©´ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
            </p>
            <div class="warning">
                âš ï¸ ì´ ì½”ë“œëŠ” 5ë¶„ í›„ ë§Œë£Œë©ë‹ˆë‹¤. ë¹ ë¥´ê²Œ ì§„í–‰í•˜ì„¸ìš”!
            </div>
            <textarea id="json-output" readonly></textarea>
            <button class="copy-btn" onclick="copyToClipboard()">
                ğŸ“‹ í´ë¦½ë³´ë“œì— ë³µì‚¬
            </button>
        </div>
    </div>

    <script>
        // ==========================================
        // PKCE ì„¤ì •
        // ==========================================
        const CLIENT_ID = 'f0c674c25c954bbe9f8be89985d5b54c';
        const REDIRECT_URI = 'https://moody-player.github.io/Moody-login/';
        const SCOPE = 'user-read-playback-state user-read-currently-playing';

        // PKCE: Code Verifier & Challenge ìƒì„±
        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return base64URLEncode(array);
        }

        function base64URLEncode(buffer) {
            return btoa(String.fromCharCode.apply(null, buffer))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return base64URLEncode(new Uint8Array(hash));
        }

        // ==========================================
        // ì¸ì¦ ì‹œì‘
        // ==========================================
        async function startAuth() {
            const codeVerifier = generateCodeVerifier();
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            
            // code_verifier ì €ì¥ (ë‚˜ì¤‘ì— í† í° êµí™˜ ì‹œ í•„ìš”)
            sessionStorage.setItem('code_verifier', codeVerifier);
            
            // Spotify ì¸ì¦ í˜ì´ì§€ë¡œ ì´ë™
            const authUrl = `https://accounts.spotify.com/authorize?` +
                `client_id=${CLIENT_ID}&` +
                `response_type=code&` +
                `redirect_uri=${encodeURIComponent(REDIRECT_URI)}&` +
                `scope=${encodeURIComponent(SCOPE)}&` +
                `code_challenge_method=S256&` +
                `code_challenge=${codeChallenge}`;
            
            window.location.href = authUrl;
        }

        // ==========================================
        // ì½œë°± ì²˜ë¦¬
        // ==========================================
        window.onload = async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const authCode = urlParams.get('code');
            const error = urlParams.get('error');
            
            if (error) {
                alert('ì¸ì¦ ì‹¤íŒ¨: ' + error);
                return;
            }
            
            if (authCode) {
                // URLì—ì„œ code ì œê±° (ë³´ì•ˆ)
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // ë¡œë”© í‘œì‹œ
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('loading-area').style.display = 'block';
                
                // í† í° êµí™˜ ë° ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                await processAuth(authCode);
            }
        }

        // ==========================================
        // í† í° êµí™˜ ë° ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        // ==========================================
        async function processAuth(authCode) {
            try {
                const codeVerifier = sessionStorage.getItem('code_verifier');
                
                if (!codeVerifier) {
                    throw new Error('Code verifierë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                // 1. í† í° êµí™˜ (PKCE)
                const tokenResponse = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        code: authCode,
                        redirect_uri: REDIRECT_URI,
                        client_id: CLIENT_ID,
                        code_verifier: codeVerifier
                    })
                });

                const tokenData = await tokenResponse.json();
                
                if (!tokenData.access_token) {
                    throw new Error(tokenData.error_description || 'í† í° êµí™˜ ì‹¤íŒ¨');
                }

                // 2. ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const userResponse = await fetch('https://api.spotify.com/v1/me', {
                    headers: {
                        'Authorization': 'Bearer ' + tokenData.access_token
                    }
                });

                const userData = await userResponse.json();

                // 3. JSON ìƒì„±
                const configData = {
                    username: userData.id,
                    client_id: CLIENT_ID,
                    client_secret: "pkce-no-secret-needed",
                    auth_code: authCode,
                    redirect_uri: REDIRECT_URI,
                    code_verifier: codeVerifier,
                    access_token: tokenData.access_token,
                    refresh_token: tokenData.refresh_token
                };

                // 4. í™”ë©´ì— í‘œì‹œ
                document.getElementById('json-output').value = JSON.stringify(configData, null, 2);
                document.getElementById('loading-area').style.display = 'none';
                document.getElementById('result-area').style.display = 'block';
                
                // code_verifier ì‚­ì œ (ë³´ì•ˆ)
                sessionStorage.removeItem('code_verifier');
                
                // ìŠ¤í¬ë¡¤
                document.getElementById('result-area').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error('ì¸ì¦ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
                document.getElementById('loading-area').style.display = 'none';
                document.getElementById('loginBtn').style.display = 'block';
            }
        }

        // ==========================================
        // í´ë¦½ë³´ë“œ ë³µì‚¬
        // ==========================================
        function copyToClipboard() {
            const textarea = document.getElementById('json-output');
            textarea.select();
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(textarea.value).then(() => {
                    alert('âœ… ë³µì‚¬ ì™„ë£Œ!\n\nMoody ì„¤ì • í™”ë©´ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.');
                });
            } else {
                document.execCommand('copy');
                alert('âœ… ë³µì‚¬ ì™„ë£Œ!\n\nMoody ì„¤ì • í™”ë©´ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.');
            }
        }
    </script>
</body>
</html>
